
{% extends "catalogue/base.html" %}
{% load bulma_tags %}
{% block title %}Catalogue Search{% endblock %}
{% block body %}
  <section class="section has-background-primary">
    <div class="columns is-flex-wrap-wrap">
      <div class="column is-full">
        <div class="columns">
          <div class="column is-one-third is-offset-one-third mb-6">
            {% include "catalogue/includes/searchbar.html" %}
          </div>
        </div>
      </div>

      <div class="column is-half-tablet is-one-quarter-desktop is-one-fifth-widescreen has-text-white">
        <form method="get" name="searchForm">
          {% with filter.form as form %}
            {% for hidden in form.hidden_fields %}
              {{ hidden }}
            {% endfor %}
            {% for field in form.visible_fields %}
              {% if field|is_input %}
                {{ field.as_hidden }}
              {% else %}
                <button class="button is-white is-outlined mb-2 is-fullwidth drop-down-button" type="button"
                        aria-label="menu" aria-expanded="false" data-target="{{ field.html_name }}dropdown">
                  <span>{{ field.label }}</span>
                  <span class="icon is-right drop-down-icon">
                    <i class="fas fa-angle-down"></i>
                    <i class="fas fa-angle-up"></i>
                  </span>
                </button>
                <div class="drop-down-menu mb-4" id="{{ field.html_name }}dropdown">
                  <div class="field">
                    <div class="control is-size-7">
                      {{ field }}
                    </div>
                  </div>
                </div>
                <div class="tags mb-1">
                  {% for id, name in field.field.choices %}
                    {% if id|stringformat:"s" in field.value %}
                      <span class="tag has-background-info is-rounded">
                        {{ name }}
                        <button type="button" value="id_{{field.name}}_{{ forloop.counter0 }}" class="delete is-small"></button>
                      </span>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          {% endwith %}
        </form>
      </div>

      <div class="column has-background-primary-light">
        <div class="container">
          <div class="columns is-flex-wrap-wrap">
            {% for c in components %}
              <div class="column is-half-desktop is-one-third-fullhd">
                {% include "catalogue/includes/component-card.html" with c=c only %}
              </div>
            {% empty %}
              <div class="column has-text-centered">
                <p class="mt-6">Keine Ergebnisse gefunden.</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <div id="feedbackModal" class="modal" hx-target="#content" hx-swap="innerHTML">
      <div class="modal-background"></div>
      <div class="modal-content">
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">Feedback</p>
            <button class="delete" aria-label="close"></button>
          </header>
          <form hx-post="{{ request.get_full_path }}">
          <div id="content">
            <section class="modal-card-body">
              {% csrf_token %}
              {{ form|bulma }}
              <input id="url" value="{{ request.get_full_path }}" hidden>
            </section>
            <footer class="modal-card-foot">
              <div class="field">
                <div class="control">
                  <button class="button is-success">Sende Feedback</button>
                </div>
              </div>
            </footer>
          </div>
        </form>
        </div>
      </div>
    </div>
    <button id="feedbackBtn" class="button is-info vertical-right-aligned">Feedback</button>
  </section>
{% endblock %}
{% block script %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // copy textfield to hidden
      const input = document.querySelector('input[type="text"]');
      const hiddenInput = document.querySelector('input[type="hidden"]');
      input.value = hiddenInput.value; // load text on page load
      input.addEventListener('input', function copyValue(e) {
          hiddenInput.value = e.target.value;
        }
      );
      // submit on keydown
      input.addEventListener('keydown', function (e) {
        if (e.keyCode === 13) {
          document.searchForm.submit();
        }
      });
      // submit form on checkbox change
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      for (let i = 0; i < checkboxes.length; i++) {
        checkboxes[i].addEventListener('change', function () {
          document.searchForm.submit();
        });
      }
      // add listener on delete Buttons for unchecking box when clicked
      const deleteButtons = document.querySelectorAll('.delete');
      for (let i = 0; i < deleteButtons.length; i++) {
        deleteButtons[i].addEventListener('click', function () {
          button = deleteButtons[i];
          checkbox = document.querySelector("input[type=checkbox][id="+button.value+"]");
          checkbox.checked = false;
          document.searchForm.submit();
        });
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // dropdown buttons
      const $dropdownButtons = Array.prototype.slice.call(document.querySelectorAll('.drop-down-button'), 0);
      if ($dropdownButtons.length > 0) {
        $dropdownButtons.forEach(el => {
          el.addEventListener('click', () => {
            el.classList.toggle("is-active");
            // Get the target from the "data-target" attribute
            const $target = document.getElementById(el.dataset.target);
            $target.classList.toggle('is-active');
          });
        });
      }
    });

    document.getElementById("feedbackBtn").addEventListener("click", function() {
      var modal = document.querySelector('.modal');
      modal.classList.add("is-active");

      modal.querySelector('.modal-background').addEventListener('click', function(e) {
        e.preventDefault();
        modal.classList.remove('is-active');
      });
      modal.querySelector('.delete').addEventListener('click', function(e) {
        e.preventDefault();
        modal.classList.remove('is-active');
      });
    });
  </script>
{% endblock %}